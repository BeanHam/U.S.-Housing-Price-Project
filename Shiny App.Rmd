---
title: "Shiny App"
output: html_document
---
```{r, echo=FALSE}
#devtools::install_github("UrbanInstitute/urbnmapr")
suppressMessages(library(shiny))
suppressMessages(library(shinythemes))
suppressMessages(library(dplyr))
suppressMessages(library(tidyverse))
suppressMessages(library(leaflet))
suppressMessages(library(RColorBrewer))
suppressMessages(library(scales))
suppressMessages(library(lattice))
```

```{r, echo=FALSE}
load("county_data.RData")
load("county_plot.Rdata")
load("recommendation_part1.RData")
load("recommendation_part2.RData")
```

Citation: https://github.com/rstudio/shiny-examples/tree/master/063-superzip-example

```{r, echo=FALSE}
county_data = county_data %>% 
  rename('Housing Price' = price,
         'Income Per Capita' = Income_PerCapita,
         'Crime Rate' = crime_rate_per_100000,
         'Unemployment Rate' = pct_unemp,
         'Num Of Colleges' = college_num,
         'Num Of Public Schools' = public_school_count,
         'Num Of Private Schools' = private_school_count,
         'Hospital Rating' = hospital_rating,
         'Num Of Shoppingmalls' = num_shoppingmall,
         'Risk Level' = RiskLevel) %>% 
  left_join(.,recommendation_for_shiny, by=c("County","State")) %>% 
  mutate(recommend = ifelse(recommend == "Highly Highly not Recommend. A very bad investment you may regret!", 1, 
                             ifelse(recommend == "Highly not Recommend. Bad deal", 2, 
                             ifelse(recommend == "Not Recommend. Worse than fair", 3,
                             ifelse(recommend == "Fair offer", 4,
                             ifelse(recommend == "Recommend. Better than fair", 5,
                             ifelse(recommend == "Highly Recommend. Great Deal.", 6, 7)))))))


county_plot=county_data %>% 
    left_join(county_plot, by=c("State","County")) %>% 
    na.omit()
    
state_list = unique(county_data$State)


variable_list = c("State",
                  "County",
                  "Population",
                  "Crime Rate",
                  "Risk Level",                  
                  "Housing Price",
                  "Hospital Rating",                  
                  "Num Of Colleges",
                  "Income PerCapita",  
                  "Unemployment Rate",                    
                  "Num Of Public Schools",
                  "Num Of Private Schools",
                  "Num Of Shoppingmalls")

vars=c("Population",
       "Crime Rate",
       "Risk Level",                  
       "Housing Price",
       "Hospital Rating",                  
       "Num Of Colleges",
       "Income PerCapita",  
       "Unemployment Rate",                    
       "Num Of Public Schools",
       "Num Of Private Schools",
       "Num Of Shoppingmalls")
```




```{r shiny, warning=FALSE, message=FALSE}

shinyApp(
  ui = tagList(
    navbarPage(
    theme = shinytheme("cosmo"),      
    "U.S. County Housing Price",
    tabPanel("County Outlook", 
             sidebarPanel(
               selectInput("state", 
                           "Select A State", 
                           choices = state_list, 
                           selected = 1),
               checkboxGroupInput("variable","Select variables to view", variable_list),
               actionButton("update", "Update"),
               hr(),
               h3("Variable Dictionary: "),
               helpText("- Crime Rate: number of crimes per 100,000"),
               helpText("- Risk Level: 9 - Highest; 0 - lowest"),
               helpText("- Housing Price: $1000/square-meters"),
               helpText("- Hospital Rating: 5 - highest; 0 - lowest"),
               helpText("- Unemployment Rate: in percentage")
               ),
             mainPanel(
               DT::dataTableOutput("table1")
               )),
    
    tabPanel("County Housing Price",
             sidebarPanel(
               selectInput("state_hist", 
                           "Select A State", 
                           choices = state_list, 
                           selected = 1),
               sliderInput("slide", 
                           label = "Choose Your Price Range", 
                           min = 0.406, max = 4, value = c(0.5, 0.6)),
               actionButton("bargraph", "Get Housing Price Distribution"),
               hr(),
               h3("Variable Dictionary: "),
               helpText("- Housing Price: $1000/m^2")
               ),
             mainPanel(
               plotOutput("distribution")
             )),
    
    
    ## create an interactive map
    tabPanel("Interactive map", 
             div(class="outer",

      tags$head(
        # Include our custom CSS
        includeCSS("styles.css"),
        includeScript("gomap.js")
      ),

      leafletOutput("map", width="100%", height="100%"),
      absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE,
        draggable = TRUE, top = 60, left = "auto", right = 20, bottom = "auto",
        width = 330, height = "auto",

        h2("Variables explorer"),

        selectInput("color", "Color", vars),
        selectInput("size", "Size", vars, selected = "Housing Price")
        
        ),

      tags$div(id="cite",
        'Data compiled for ', tags$em('Coming Apart: The State of White America, 1960â€“2010'), ' by Charles Murray (Crown Forum, 2012).',"code from https://github.com/rstudio/shiny-examples/tree/master/063-superzip-example"
      )
      )
      ),
    
    
    ## recommendation system
    tabPanel("Recommendation Level -- From Modeling", 
             sidebarPanel(
               selectInput("state_rd", "Select A State", choices = state_list, selected = 1),
               actionButton("recommend", "Get Recommendation"),
               hr(),
               h4("Recommendation Level Instruction: "),
               helpText("The larger the level, the more highly the county is recommended."),
               helpText("- 1: Extremely Not Recommended."),
               helpText("- 2: Highly Not Recommended."),
               helpText("- 3: Not Recommended."),
               helpText("- 4: Fair Offer."),
               helpText("- 5: Recommened."),
               helpText("- 6: Highly Recommended."),
               helpText("- 7: Extremely Recommended.")           
               
               ),
             mainPanel(
               plotOutput("recommendation_level", height = "600px"),
               htmlOutput(("Instruction"))
               )),
    
    
    tabPanel("Recommendation Score -- From Dataset", 
             sidebarPanel(
               selectInput("rank_state", 
                           "Select A State", 
                           choices = state_list,
                           selected = 1),
               
               checkboxGroupInput("variable_rd",
                                  "Select variables to rank",
                  c("Cheap","safety","income","transportation","cpi","economic","tax","school","shopping")),
               actionButton("rank", "Get Recommendation Score"),
               hr(),
               h3("Variable Dictionary: "),
               helpText("- Cheap: the cheaper the housing price, the higher the score"),
               helpText("- Safety: the safer the county area is, the higher the score"),
               helpText("- Income: the higher the income level in the county, the higher the score"),
               helpText("- Transportation: the more convenient the transportation is, the higher the score"),
               helpText("- CPI: the higher the CPI is, the higher the score"),
               helpText("- Economic: the more developed the county is, the higher the score"),
               helpText("- Tax: the lower the tax rate is, the higher the score"),
               helpText("- School: the larger number of schools in the county, the higher the score"),
               helpText("- Shopping: the larger number of shopping malls in the county, the higher the score")
               ),
             mainPanel(
               htmlOutput("rank_level_instruction"),
               plotOutput("rank_plot", height = "500px")
               ))
))
,
  
  server = function(input, output, session){
    
    ## panel1 
    tabledata = eventReactive(
      input$update,{
      county_data %>% filter(State == input$state) %>% select(input$variable)
    })
    
    output$table1 = DT::renderDataTable(DT::datatable({
      tabledata()
      }))
    
    
    ## panel 2
    observeEvent(
      input$state_hist, {
        histdata = county_data %>% filter(State == input$state_hist)
        updateSliderInput(session, "slide",
                          min = min(histdata$`Housing Price`),
                          max = max(histdata$`Housing Price`))
      })
    
    histdata = eventReactive(
      input$bargraph, {
        county_data %>% filter(State == input$state_hist,
                               `Housing Price`<= input$slide[2],
                               `Housing Price` >= input$slide[1])
      }
    )
    
    output$distribution = renderPlot({
      plot = histdata()
      
      ggplot(data = plot, 
             aes(x = reorder(County, -`Housing Price`), 
                 y = `Housing Price`,
                 fill = `Housing Price`)) +
        geom_bar(stat = "identity",
                 color = "black",
                 position = position_dodge()) +
        geom_text(aes(label = `Housing Price`),
                  position = position_dodge(0.9),
                  vjust = 1.6,
                  size = 3.5,
                  color = "black") +
        xlab("County") +
        ylab("Housing Price ($1000/m^2)") +
        theme(axis.text.x = element_text(angle = 40, hjust = 1, vjust = 1)) +
        scale_fill_gradient(low="lightblue", high="pink")
      })
    
    
    ## panel 3
    # Create the map
    output$map <- renderLeaflet({
      leaflet() %>%
        addTiles(
          #urlTemplate = "//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png",
          attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>'
          ) %>%
        setView(lng = -93.85, lat = 37.45, zoom = 4)
      })
    
    observe({
    colorBy <- input$color
    sizeBy <- input$size

    colorData <- county_plot[[colorBy]]
    pal <- colorBin("viridis", colorData, 7, pretty = FALSE)
    radius <- county_plot[[sizeBy]] / max(county_plot[[sizeBy]]) * 30000
    

    leafletProxy("map", data = county_plot) %>%
      clearShapes() %>%
      addCircles(~Long, ~Lat, radius=radius, layerId=~Zipcode,
        stroke=FALSE, fillOpacity=0.4, fillColor=pal(colorData)) %>%
      addLegend("bottomleft", pal=pal, values=colorData, title=colorBy,
        layerId="colorLegend")
    })
    
    # Show a popup at the given location
    showZipcodePopup <- function(zipcode, lat, lng) {
    selectedZip <- county_plot[county_plot$Zipcode == zipcode,]
    content <- as.character(tagList(
      tags$h4(selectedZip$recommend),
      tags$strong(HTML(sprintf("%s, %s %s",
        selectedZip$City, selectedZip$County, selectedZip$State)))
    ))
    leafletProxy("map") %>% addPopups(lng, lat, content, layerId = zipcode)
    }

    # When map is clicked, show a popup with city info
    observe({
      leafletProxy("map") %>% clearPopups()
      event <- input$map_shape_click
      if (is.null(event))
        return()
      
      isolate({
        showZipcodePopup(event$id, event$lat, event$lng)
      })
    })
  
    ### panel 4
    barplotdata = eventReactive(
      input$recommend,{
        county_data %>% 
          filter(State==input$state_rd) %>% 
          select(County,recommend) %>% 
          arrange(recommend)
        
    })
    
    output$Instruction = renderUI({
      
      str1 = "The recommendation level is based on the test result from the predicting model underneath the App. The smaller difference between the real price and the predicted price, the more highly the county is recommended."
      str2 = "Choose a state you want to look at and check the recommendation levels for all the counties within that state."
      
      HTML(paste(str1, str2, sep = '<br/><br/>'))
    })
    
    
    output$recommendation_level = renderPlot({
      barplot=barplotdata()
      
      ggplot(data = barplot, 
             aes(x = reorder(County, -recommend), 
                 y = recommend,
                 fill = recommend)) + 
        geom_bar(stat="identity",
                 width = 1) + 
        xlab("County") + 
        ylab("recommendation level") +
        coord_flip() +
        theme(axis.text.y = element_text(size = 8))
      })
    
    
    
    ### panel5 
    tabledata2 = eventReactive(
      input$rank,{
        
        state_county = county_data_recommend_for_shiny %>% 
          filter(State == input$rank_state) %>% 
          select(County, State)
        
        county_data_recommend_for_shiny %>% 
          filter(State == input$rank_state) %>% 
          select(input$variable_rd) %>% 
          mutate(average = round(rowSums(.)/ncol(.), 2),
                 location = paste(state_county$County,
                                  ",",
                                  state_county$State)) %>% 
          arrange(desc(average)) %>% 
          .[1:20, ]
        })
    
    output$rank_level_instruction = renderUI({
      
      str1 = "Based on the values of each variable, we assigned a generalized score for each variable in each county. The higher the score is, the better the indicator is. The overall recommendation score is the average score of all the variables you choose."
      str2 = "Choose a state or multiple states you want to look at and select the features that are more important to you. Then check which county is the best for you!"
      
      HTML(paste(str1, str2, sep = '<br/><br/>'))
    })
        
        
    output$rank_plot = renderPlot({
      plot = tabledata2()
      
      ggplot(data = plot, 
             aes(x = reorder(location, -average), 
                 y = average,
                 fill = average)) +
        geom_bar(stat = "identity",
                 color = "black",
                 position = position_dodge()) +
        geom_text(aes(label = average),
                  position = position_dodge(0.9),
                  vjust = 1.6,
                  size = 3.5,
                  color = "black") +
        xlab("State & County") +
        ylab("Overall Recommendation Score") +
        theme(axis.text.x = element_text(angle = 40, hjust = 1, vjust = 1)) +
        scale_fill_gradient(low="lightblue", high="pink")
      })
    
    }
)
```

Citation: 
1. https://stackoverflow.com/questions/3991905/sum-rows-in-data-frame-or-matrix
2. https://stackoverflow.com/questions/17838709/scale-and-size-of-plot-in-rstudio-shiny
3. https://stackoverflow.com/questions/23233497/outputting-multiple-lines-of-text-with-rendertext-in-r-shiny


## Shiny App Details
There are five different panels in our shiy app, with each one containing different information and serving different functions. The steps to build these panals and the functionalities of them will be articulated in details:  

The overall set up of the shiny app is a `navbarPage` under the `tagList`. We created five `tabPanel` with the page and applied the theme "cosmo". 

### 1. County Outlook: 

- Construction: the first panel is called "County Outlook", which contains a table with general information of each county, such as GDP, population, unemployment rate etc. In the `sidebarPanel`, users can select whichever state they want to look at and choose the variables they are interested in. We also added some `helpText` to explain each variable to help users understand. The `mainPanel` displays a table.  

- Functionality: This panel gives users an overall idea of what each county looks like. Instead of just showing the average housing price for each county, they can capture more useful information. Additionally, users can sort any column and search any key word on the table.

- Usage: Users choose a state and specify the variables they are interested from the provided list. By clicking the "update" button, the table will show up.

### 2. County Housing Price: 

- Construction: similarly, we added a `selectInput`, allowing users to select a state they want to look at. Then we incorporated a`sliderInput` for users to specify the housing price range. Since the range for each state is different, we used an `obserEvent` function to update the max and min value of sliderInput once there is anything changed in "state_list". Once the "histogram" button is triggered, the `mainPanel` will generate a barplot, with `County` on the horizontal axis and `Housing Price` on the vertical axis.

- Funcationality: considering that some users are interested in the distribution of housing prices in different counties in a state, we created this panel. It can help users narrow the search scope of different locations.

- Usage: Choose a state and the slider range will automatically update. Then move the slider and specify the range you want to look at. Then click "Get Housing Price Distribution" button.

### 3. Interactive Map

- Another designed function of our shiny App is the interactive map. In this tabpanel users can select two interested variables from the previous dataset we obtained and they will be plotted on the US map. After looking at an excellent example called "SuperZip" from shiny gallery, we used leaflet package to draw this elegant map but to find the location of each county we need to use its coordinates. To solve this task we used the longitude, latitude and Zipcode of some cities in one county and cities in one county will have identical values such as housing price,income per capita.

- In the server function we created a map first and then drew tiny circles representing cities on the top of previous map layer. The radius and the color of each circle is controlled by input variables so that our users can compare the values by the circle size and  color. The reason why we decided to change the color and size at the same time is to explore the interactions between the selected two variables. In addition we added our recommendation results to a popup window.


### 4. Recommendation Level -- From Modeling

- Construction: similar as before, we added a `selectInput` for users to choose a state. We alsp provided the explanations of different recommendation levels using `helpText`. The `mainPanel` contains a `plotOutput` and a `htmlOutput`. We used a `eventReactive` function to create a new dataframe only containing the observations of the state users specify. Afterthen, when the "recommend" button is clicked, a barplot will be generated, with different recommendation level grouped together. 

- Funcationality: this panel is used to show what is the recommended county from the modeling step. If the real price and predictive price are very close for a county, then we say the county is recommended (based on the magnitude of the difference, we classify the level of recommendation). This will give users some idea of whether a county is worth an investment or not in general. 

- Usage: Choose a state and click "Get Recommendation". Then a bar plot will show up.

### 5. Recommendation Score -- From Dataset

- Construction: In the last panel, we used a `selectInput` for state choice and used `checkboxGroupInput` for users to choose different variables. Same as the 4th panel, we added some `helpText` to help readers understand what are those variables. The `mainPanel` contains a `htmlOutput` and a `plotOutput`. In the mainPanel, we used an `evenReactive` function. Whenever the input state changes, a dataframe will be generated correspondingly, with the overall recommendation score as a variable. Then a bar plot will be created, with County&State on the horizontal axis and recommendation score on the vertical axis.

- Functionality: we used a different datafram for this panel. Based on the values of each variable in the original dataset, we assigned a generalized score for each value of that variable from 0 - 100. And then we average the generalized scores of the variables that users choose to calculate the overall score. The recommendation from 4th panel is based on the modeling result, showing how close the predicted value is to the real value. However, in this panel, users can specify the variables to be used in the recommendation system and we calculate the score in the backstage. The higher the score, the more recommended the county is.

- Usage: select one or more states and click "Get Recommendation Score".



