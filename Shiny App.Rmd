---
title: "Shiny App"
output: html_document
---
```{r}
#devtools::install_github("UrbanInstitute/urbnmapr")
suppressMessages(library(shiny))
suppressMessages(library(shinythemes))
suppressMessages(library(dplyr))
suppressMessages(library(tidyverse))
suppressMessages(library(leaflet))
suppressMessages(library(RColorBrewer))
suppressMessages(library(scales))
suppressMessages(library(lattice))
```

```{r}
load("county_data.RData")
load("county_plot.Rdata")
load("recommendation_part1.RData")
load("recommendation_part2.RData")
```

Citation: https://github.com/rstudio/shiny-examples/tree/master/063-superzip-example

```{r}
county_plot=county_data %>% 
    left_join(county_plot, by=c("State","County")) %>% 
    rename('Housing Price' = price,
         'Income Per Capita' = Income_PerCapita,
         'Crime Rate' = crime_rate_per_100000,
         'Unemployment Rate' = pct_unemp,
         'Num Of Colleges' = college_num,
         'Num Of Public Schools' = public_school_count,
         'Num Of Private Schools' = private_school_count,
         'Hospital Rating' = hospital_rating,
         'Num Of Shoppingmalls' = num_shoppingmall,
         'Risk Level' = RiskLevel) %>% 
    na.omit()
    
state_list = unique(county_data$State)


county_data = county_data %>% 
  rename('Housing Price' = price,
         'Income Per Capita' = Income_PerCapita,
         'Crime Rate' = crime_rate_per_100000,
         'Unemployment Rate' = pct_unemp,
         'Num Of Colleges' = college_num,
         'Num Of Public Schools' = public_school_count,
         'Num Of Private Schools' = private_school_count,
         'Hospital Rating' = hospital_rating,
         'Num Of Shoppingmalls' = num_shoppingmall,
         'Risk Level' = RiskLevel)

variable_list = c("State",
                  "County",
                  "Population",
                  "Crime Rate",
                  "Risk Level",                  
                  "Housing Price",
                  "Hospital Rating",                  
                  "Num Of Colleges",
                  "Income PerCapita",  
                  "Unemployment Rate",                    
                  "Num Of Public Schools",
                  "Num Of Private Schools",
                  "Num Of Shoppingmalls")

vars=c("Population",
       "Crime Rate",
       "Risk Level",                  
       "Housing Price",
       "Hospital Rating",                  
       "Num Of Colleges",
       "Income PerCapita",  
       "Unemployment Rate",                    
       "Num Of Public Schools",
       "Num Of Private Schools",
       "Num Of Shoppingmalls")
```

```{r shiny, warning=FALSE, message=FALSE}

shinyApp(
  ui = tagList(
    navbarPage(
    theme = shinytheme("cosmo"),      
    "U.S. County Housing Price",
    tabPanel("County Outlook", 
             sidebarPanel(
               selectInput("state", "Select A State", choices = state_list, selected = 1),
               checkboxGroupInput("variable","Select variables to view", variable_list),
               actionButton("update", "Update"),
               hr(),
               h3("Variable Dictionary: "),
               helpText("- Crime Rate: number of crimes per 100,000"),
               helpText("- Risk Level: 9 - Highest; 0 - lowest"),
               helpText("- Housing Price: $1000/square-meters"),
               helpText("- Hospital Rating: 5 - highest; 0 - lowest"),
               helpText("- Unemployment Rate: in percentage")
               ),
             mainPanel(
               DT::dataTableOutput("table1")
               )),
    
    tabPanel("County Housing Price",
             sidebarPanel(
               selectInput("state_hist", "Select A State", choices = state_list, selected = 1),
               sliderInput("slide", 
                           label = "Choose Your Price Range", 
                           min = 0.406, max = 4, value = c(0.5, 0.6)),
               actionButton("histogram", "Get Housing Distribution"),
               hr(),
               h3("Variable Dictionary: "),
               helpText("- Housing Price: $1000/m^2")
               ),
             mainPanel(
               plotOutput("distribution")
             )),
    
    ## create an interactive map
    tabPanel("Interactive map", 
             div(class="outer",

      tags$head(
        # Include our custom CSS
        includeCSS("styles.css"),
        includeScript("gomap.js")
      ),

      # If not using custom CSS, set height of leafletOutput to a number instead of percent
      leafletOutput("map", width="100%", height="100%"),

      # Shiny versions prior to 0.11 should use class = "modal" instead.
      absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE,
        draggable = TRUE, top = 60, left = "auto", right = 20, bottom = "auto",
        width = 330, height = "auto",

        h2("Variables explorer"),

        selectInput("color", "Color", vars),
        selectInput("size", "Size", vars, selected = "Housing Price")
        
        ),

      tags$div(id="cite",
        'Data compiled for ', tags$em('Coming Apart: The State of White America, 1960â€“2010'), ' by Charles Murray (Crown Forum, 2012).',"code from https://github.com/rstudio/shiny-examples/tree/master/063-superzip-example"
      )
    )
  )
))
,
  
  server = function(input, output, session){
    
    ## panel1 
    tabledata = eventReactive(
      input$update,{
      county_data %>% filter(State == input$state) %>% select(input$variable)
    })
    
    output$table1 = DT::renderDataTable(DT::datatable({
      tabledata()
      }))
    
    ## panel 2
    # Create the map
    output$map <- renderLeaflet({
    leaflet() %>%
      addTiles(
        #urlTemplate = "//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png",
        attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>'
      ) %>%
      setView(lng = -93.85, lat = 37.45, zoom = 4)
  })
    
    observe({
    colorBy <- input$color
    sizeBy <- input$size

    colorData <- county_plot[[colorBy]]
    pal <- colorBin("viridis", colorData, 7, pretty = FALSE)
    radius <- county_plot[[sizeBy]] / max(county_plot[[sizeBy]]) * 30000
    

    leafletProxy("map", data = county_plot) %>%
      clearShapes() %>%
      addCircles(~Long, ~Lat, radius=radius, layerId=~Zipcode,
        stroke=FALSE, fillOpacity=0.4, fillColor=pal(colorData)) %>%
      addLegend("bottomleft", pal=pal, values=colorData, title=colorBy,
        layerId="colorLegend")
  })
    
    # panel 3
    observeEvent(
      input$state_hist, {
        histdata = county_data %>% filter(State == input$state_hist)
        updateSliderInput(session, "slide",
                          min = min(histdata$`Housing Price`),
                          max = max(histdata$`Housing Price`))
      })
    
    histdata = eventReactive(
      input$histogram, {
        county_data %>% filter(State == input$state_hist,
                               `Housing Price`<= input$slide[2],
                               `Housing Price` >= input$slide[1])
      }
    )
    
    output$distribution = renderPlot({
      plot = histdata()
      
      ggplot(data = plot, 
             aes(x = reorder(County, -`Housing Price`), 
                 y = `Housing Price`,
                 fill = `Housing Price`)) +
        geom_bar(stat = "identity",
                 color = "black",
                 position = position_dodge()) +
        geom_text(aes(label = `Housing Price`),
                  position = position_dodge(0.9),
                  vjust = 1.6,
                  size = 3.5,
                  color = "black") +
        xlab("County") +
        ylab("Housing Price ($1000/m^2)") +
        theme(axis.text.x = element_text(angle = 40, hjust = 1, vjust = 1)) +
        scale_fill_gradient(low="lightblue", high="pink")
      })
  }
  
)
```

## Shiny App Details
There are severals panels in our the shiy app, with each one containing different information. 

1. County Outlook: this panel displays a table containing the general information of some indicators for each county. This panel takes the cleaned dataframe as input and users can select which state they want to look at. Then, they can specify the variables they are interested in. By clicking 'Update', the table will show up on the right. Users can further do some search, filter, and sort on the table. 

2. County Housing Price: considering that some users are interested in the distribution of housing prices in different counties in a state, we created this panel. Users chooses a state and the lower and upper bound of the housing price will update automatically. Then users can specify the range of prices they want to look at and a bar graph (sorted by the price in descending order) will show up, with counties on the x-axis. 












