---
title: "sta523 final project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
library(Quandl)
library(readr)
library(dplyr)
library(rvest)
library(stringr)
library(xlsx)
library(noncensus)
library(rvest)
library(tidyverse)
library(sqldf)
library(stringi)
library(readxl)
library(tools)
```

1. base data

```{r}
pricepersqft = read_csv("pricepersqft__.csv")

county_count = pricepersqft %>% dplyr::select(County,State) %>% 
  group_by(County,State) %>% summarize(count = length(County))

price_2017 = pricepersqft %>% 
  dplyr::select(County,State, `17-Jan`) %>%
  group_by(County,State) %>% 
  summarize(price = median(`17-Jan`))
```


2. Population data from wikipedia

```{r}
url <- "https://en.wikipedia.org/wiki/List_of_United_States_counties_by_per_capita_income"

df = read_html(url) %>%
  html_nodes("table.wikitable.sortable") %>%
  .[[1]] %>%
  html_table() %>% 
  filter(.$State != "")


county_data <- data.frame(
  County = df$`County-equivalent` %>% as.character(.),
  State = df$State %>% as.character(.),
  Income_PerCapita = df$`Per capitaincome` %>% 
    str_replace_all(",", "") %>%
    substr(2, 10000) %>% 
    as.numeric(as.character(.)),
  Median_Household_Income = df$Medianhouseholdincome %>% 
    str_replace_all(",", "") %>%
    substr(2, 10000) %>% 
    as.numeric(as.character(.)),
  Median_Family_Income = df$Medianfamilyincome %>% 
    str_replace_all(",", "") %>%
    substr(2, 10000) %>% 
    as.numeric(as.character(.)),
  Population = df$Population %>% 
    str_replace_all(",", "") %>% 
    as.numeric(as.character(.)),
  Num_Household = df$`Number ofhouseholds` %>% 
    str_replace_all(",", "") %>% 
    as.numeric(as.character(.))
)

county_data$State = state.abb[match(county_data$State,state.name)]

'%ni%' <- Negate('%in%')

difficult_county = price_2017[price_2017$County %ni% county_data$County,]
```

```{r}
w = which(price_2017$County == difficult_county$County[1])
w[length(w)]
price_2017[w[1]:w[length(w)], 1] = 'Delaware County'

w = which(price_2017$County == difficult_county$County[8])
ww = which(price_2017$County == difficult_county$County[25])

price_2017[w[1]:ww, 1] = w[1]:ww %>% sapply(function(i){
     paste0('St.',substr(price_2017[i,1],6,100))})

w = which(price_2017$County == difficult_county$County[26])
price_2017[w[1]:w[length(w)], 1] = 'Washington County'

difficult_county = price_2017[price_2017$County %ni% county_data$County,]

w = which(price_2017$County == difficult_county$County[3])
price_2017[w[1]:w[length(w)], 1] = 'St. Louis County'

w = which(price_2017$County == difficult_county$County[5])
price_2017[w[1]:w[length(w)], 1] = "St. Mary's"

price_2017_2 = merge(price_2017,county_data,by = c('County','State'))

```

3. hilton data within the country

```{r}
baseURL =  "https://www3.hilton.com"
links = read_html("https://www3.hilton.com/en/hotel-locations/us/index.html") %>%
    html_nodes(.,'ul.directory_locations_list li a') 
states = html_text(links)
urls = html_attr(links, "href") %>% paste0(baseURL, .)

zips = sapply(urls, function(url){
     url %>%
         read_html() %>%
         html_nodes('ul.directory_locations_list li a') %>%
         {paste0(baseURL, html_attr(., "href"))} %>%
         sapply(function(locationURL){
             locationURL %>%
                 read_html() %>%
                 html_nodes('ul.directory_hotels_list li') %>%
                 html_text() %>%
                 str_replace("\t", "") %>%
                 str_replace("\r\n", "") %>%
                 {strsplit(., " ")[[1]]} %>%
                 {.[length(.)]} %>%
                 {strsplit(., "USA")[[1]][1]} %>%
                 substr(1, 5)
             })
 }) %>%
     unlist() %>%
     unname() %>%
    as.data.frame() 
colnames(zips) = "zips"
```

```{r}
zip_county_lookup = read_csv("ZIP-COUNTY-FIPS_2018-03.csv")

hilton_county = merge(zips,zip_county_lookup,by.x ='zips',by.y = 'ZIP') %>%
     mutate(COUNTYNAME = COUNTYNAME %>%
                str_locate_all(" ") %>%
                sapply(function(mat){mat[min(dim(mat), 2), 1] - 1}) %>%
                {str_sub(COUNTYNAME, 1, .)})

distinct_count = hilton_county%>%
  group_by(COUNTYNAME,STATE) %>%
  summarize(count = length(COUNTYNAME)) %>%
    mutate(hilton_count = count) %>% 
    dplyr::select(COUNTYNAME,STATE,hilton_count)
    
price_2017_3 = left_join(price_2017_2, distinct_count, by = c("County"="COUNTYNAME","State" = "STATE")) %>%
  mutate_all(funs(replace(., is.na(.), 0)))

```


